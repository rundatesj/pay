<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>강사 급여명세서</title>
  <link rel="stylesheet" href="./style.css?v=3" />
  <!-- CSV 파서 & PDF 변환 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>
<body>
  <main class="container">
    <h1>강사 급여명세서</h1>

    <section class="controls">
      <label for="teacherSelect">강사 선택</label>
      <select id="teacherSelect"><option>불러오는 중...</option></select>

      <label for="monthSelect">월 선택</label>
      <select id="monthSelect" disabled><option>먼저 강사를 선택하세요</option></select>

      <button id="downloadPdfBtn" disabled>PDF로 저장</button>
    </section>

    <section id="payslip" class="card">
      <h2 id="title">급여명세서</h2>
      <div class="grid">
        <div><strong>이름</strong><div id="f_name">-</div></div>
        <div><strong>소속지점</strong><div id="f_branch">-</div></div>
        <div><strong>급여월</strong><div id="f_month">-</div></div>
        <div><strong>지급일</strong><div id="f_payday">-</div></div>
      </div>

      <hr/>

      <div class="grid wide">
        <div><strong>업무수당</strong><div id="f_duty">-</div></div>
        <div><strong>개인레슨수당</strong><div id="f_personal">-</div></div>
        <div><strong>그룹레슨수당</strong><div id="f_group">-</div></div>
        <div><strong>기타수당</strong><div id="f_etc">-</div></div>
        <div><strong>매출수당</strong><div id="f_sales">-</div></div>
        <div><strong>직책수당</strong><div id="f_position">-</div></div>
        <div><strong>합계</strong><div id="f_total">-</div></div>
        <div><strong>소득세</strong><div id="f_tax">-</div></div>
        <div><strong>지방세</strong><div id="f_localTax">-</div></div>
      </div>

      <div class="net">
        <span>실지급액</span>
        <strong id="f_net">-</strong>
      </div>
    </section>

    <footer>© 모던필라테스</footer>
  </main>

  <script>
    // ===== 1) 설정 =====
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/1UXjVrDeamV2e0xacvyMTVZw6_JS1P4JiSf969QFfaNk/export?format=csv&gid=0";

    const COL = {
      name: 0, branch: 1, month: 2, payday: 3,
      duty: 4, personal: 5, group: 6, etc: 7,
      sales: 8, position: 9, total: 10, tax: 11, localTax: 12, net: 13
    };

    const el = (id) => document.getElementById(id);
    const fmt = (n) => {
      const x = (typeof n === "string") ? n.replace(/,/g,"") : n;
      const num = Number(x || 0);
      return num.toLocaleString("ko-KR");
    };

    let latestByKey = new Map(); // { "이름|월" : row }

    // ===== 2) CSV 불러오기 =====
    Papa.parse(CSV_URL, {
      download: true,
      header: false,
      complete: (res) => {
        const rows = res.data.filter(r => r.length >= 14).slice(1); // 헤더 제외

        // 이름+월 기준으로 최신행 저장
        latestByKey = new Map();
        for (const r of rows) {
          const key = `${r[COL.name]}|${r[COL.month]}`.trim();
          if (r[COL.name] && r[COL.month]) latestByKey.set(key, r);
        }

        // 강사 목록 채우기
        const teacherNames = [...new Set(rows.map(r => r[COL.name]).filter(Boolean))];
        teacherNames.sort();

        const teacherSel = el("teacherSelect");
        teacherSel.innerHTML = '<option value="">강사 선택</option>' +
          teacherNames.map(n => `<option value="${n}">${n}</option>`).join("");

        teacherSel.disabled = false;
        el("monthSelect").disabled = true;
        el("downloadPdfBtn").disabled = true;

        setupEvents();
      },
      error: (err) => {
        alert("시트를 불러오지 못했습니다. 공개 범위를 확인하세요.");
        console.error(err);
      }
    });

    // ===== 3) 이벤트 설정 =====
    function setupEvents() {
      const teacherSel = el("teacherSelect");
      const monthSel = el("monthSelect");
      const downloadBtn = el("downloadPdfBtn");

      // 강사 선택 시 → 해당 강사의 월 목록 채우기
      teacherSel.addEventListener("change", () => {
        const name = teacherSel.value;
        if (!name) return;

        const months = [];
        for (const [key, r] of latestByKey.entries()) {
          if (key.startsWith(`${name}|`)) months.push(r[COL.month]);
        }
        const uniqueMonths = [...new Set(months)];
        uniqueMonths.sort(); // 필요시 reverse()로 최신 우선

        monthSel.innerHTML = '<option value="">월 선택</option>' +
          uniqueMonths.map(m => `<option value="${m}">${m}</option>`).join("");
        monthSel.disabled = uniqueMonths.length === 0;
        downloadBtn.disabled = true;
      });

      // 월 선택 시 → 해당 행 보여주기
      monthSel.addEventListener("change", () => {
        const name = teacherSel.value;
        const month = monthSel.value;
        const row = latestByKey.get(`${name}|${month}`);
        if (row) {
          renderPayslip(row);
          downloadBtn.disabled = false;
        } else {
          alert("해당 월 데이터가 없습니다.");
          downloadBtn.disabled = true;
        }
      });

      // PDF 다운로드
      downloadBtn.addEventListener("click", () => {
        const name = el("f_name").textContent || "급여명세서";
        const month = el("f_month").textContent || "";
        const opt = {
          margin: 10,
          filename: `${name}_${month}_급여명세서.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().from(el("payslip")).set(opt).save();
      });
    }

    // ===== 4) 렌더링 =====
    function renderPayslip(r) {
      el("title").textContent = `${r[COL.month]} 급여명세서`;

      el("f_name").textContent = r[COL.name] || "-";
      el("f_branch").textContent = r[COL.branch] || "-";
      el("f_month").textContent = r[COL.month] || "-";
      el("f_payday").textContent = r[COL.payday] || "-";

      el("f_duty").textContent = fmt(r[COL.duty]);
      el("f_personal").textContent = fmt(r[COL.personal]);
      el("f_group").textContent = fmt(r[COL.group]);
      el("f_etc").textContent = fmt(r[COL.etc]);
      el("f_sales").textContent = fmt(r[COL.sales]);
      el("f_position").textContent = fmt(r[COL.position]);
      el("f_total").textContent = fmt(r[COL.total]);
      el("f_tax").textContent = fmt(r[COL.tax]);
      el("f_localTax").textContent = fmt(r[COL.localTax]);
      el("f_net").textContent = fmt(r[COL.net]);
    }
  </script>
</body>
</html>
